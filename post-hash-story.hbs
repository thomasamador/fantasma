{{!--
=============================================================================
STORY POST TEMPLATE
=============================================================================

Template for fiction/narrative content with immersive reading experience.
Triggered by adding the internal tag #story to a post.

FEATURES:
- Large hero image for cover art
- Drop caps on first paragraph
- Generous line-height (1.9) for reading comfort
- Optional table of contents
- Chapter heading support
- End mark ornament

LAYOUT:
- Centered, wider content (70ch)
- Text indentation for paragraphs
- Centered footer with author

CSS CLASSES (see assets/css/custom.css ยง12):
- .post-story: Article wrapper
- .story-hero: Cover image
- .story-content: Main text (with drop caps)
- .story-toc: Table of contents block
--}}
{{!< default}}

{{#post}}
<article class="post post-story {{post_class}}">
    {{!-- Immersive header with optional chapter artwork --}}
    {{#if feature_image}}
        <figure class="story-hero">
            <img 
                src="{{img_url feature_image size="xl"}}" 
                alt="{{#if feature_image_alt}}{{feature_image_alt}}{{else}}{{title}}{{/if}}"
                loading="eager"
            >
            {{#if feature_image_caption}}
                <figcaption>{{feature_image_caption}}</figcaption>
            {{/if}}
        </figure>
    {{/if}}

    <header class="story-header">
        <h1>{{title}}</h1>
        {{#if custom_excerpt}}
            <p class="story-tagline">{{custom_excerpt}}</p>
        {{/if}}
        
        <div class="story-meta">
            {{#primary_author}}
                <span class="story-author">by {{name}}</span>
            {{/primary_author}}
            {{#if reading_time}}
                <span class="story-reading-time">{{reading_time}} min read</span>
            {{/if}}
        </div>
    </header>

    {{!-- Table of Contents - generated via JS from h2 headings --}}
    <nav class="story-toc" aria-label="Table of Contents">
        <h2>Chapters</h2>
        <ol id="story-toc-list">
            {{!-- Populated by JavaScript --}}
        </ol>
    </nav>

    {{!-- Story content - h2s become chapters --}}
    <section class="story-content">
        {{content}}
    </section>

    <footer class="story-footer">
        {{!-- Tags --}}
        {{#if primary_tag}}
            <p class="story-tags">
                {{#foreach tags visibility="public"}}
                    <a href="{{url}}">{{name}}</a>{{#unless @last}}, {{/unless}}
                {{/foreach}}
            </p>
        {{/if}}

        {{!-- Author --}}
        {{#foreach authors}}
            <section class="story-author-card">
                {{#if profile_image}}
                    <img 
                        src="{{img_url profile_image size="xs"}}" 
                        alt="{{name}}"
                        class="author-avatar"
                    >
                {{/if}}
                <div>
                    <strong>{{name}}</strong>
                    {{#if bio}}
                        <p>{{bio}}</p>
                    {{/if}}
                </div>
            </section>
        {{/foreach}}

        <p class="story-end-mark">&#9632;</p>
    </footer>
</article>

{{!-- TOC Generation Script --}}
<script>
(function() {
    const content = document.querySelector('.story-content');
    const tocList = document.getElementById('story-toc-list');
    const headings = content.querySelectorAll('h2');
    
    if (headings.length === 0) {
        document.querySelector('.story-toc').style.display = 'none';
        return;
    }
    
    headings.forEach((heading, index) => {
        // Add ID for linking
        const id = heading.id || 'chapter-' + (index + 1);
        heading.id = id;
        heading.classList.add('story-chapter-heading');
        
        // Create TOC entry
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + id;
        a.textContent = heading.textContent;
        li.appendChild(a);
        tocList.appendChild(li);
    });
})();
</script>
{{/post}}
